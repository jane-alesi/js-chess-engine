name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    - name: Use Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing npm dependencies..."
        npm install --verbose
        echo "âœ… Dependencies installed successfully"
    
    - name: Display dependency tree
      run: |
        echo "ğŸŒ³ Dependency tree overview:"
        npm list --depth=0 || true
        echo ""
    
    - name: Security Audit
      run: |
        echo "ğŸ”’ Running comprehensive npm security audit..."
        echo "ğŸ“Š Audit level: moderate (catches moderate and high severity)"
        npm audit --audit-level=moderate
        echo "âœ… Security audit completed - no vulnerabilities found"
    
    - name: Show npm audit summary
      if: failure()
      run: |
        echo "âŒ Security audit failed - showing detailed report:"
        npm audit || true
        echo ""
        echo "ğŸ”§ Available fixes:"
        npm audit fix --dry-run || true
    
    - name: Run tests
      run: |
        echo "ğŸ§ª Running test suite..."
        npm test
        echo "âœ… All tests passed"
    
    - name: Run lint
      run: |
        echo "ğŸ” Running ESLint code quality checks..."
        npm run lint
        echo "âœ… Code quality checks passed"
    
    - name: Build summary
      if: success()
      run: |
        echo "ğŸ‰ Build completed successfully!"
        echo "âœ… Dependencies: Installed"
        echo "âœ… Security: No vulnerabilities"
        echo "âœ… Tests: All passing"
        echo "âœ… Linting: No issues"