name: CI/CD Pipeline

# This workflow runs AFTER the auto-fix workflow completes to ensure code quality fixes are applied first
on:
  # Primary trigger: Run after auto-fix workflow completes
  workflow_run:
    workflows: ["Auto-Fix Code Quality"]
    types:
      - completed
    branches:
      - main
  
  # Fallback trigger: Run directly on push/PR if auto-fix doesn't run
  # This handles cases where auto-fix is skipped (e.g., [auto-fix] commits)
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # Wait for auto-fix completion (only for workflow_run triggers)
  wait-for-auto-fix:
    if: github.event_name == 'workflow_run'
    runs-on: ubuntu-latest
    outputs:
      auto-fix-status: ${{ steps.check-status.outputs.status }}
    
    steps:
      - name: Check auto-fix workflow status
        id: check-status
        run: |
          echo "ğŸ” Checking auto-fix workflow status..."
          if [ "${{ github.event.workflow_run.conclusion }}" == "success" ]; then
            echo "âœ… Auto-fix workflow completed successfully"
            echo "status=success" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.workflow_run.conclusion }}" == "skipped" ]; then
            echo "â­ï¸ Auto-fix workflow was skipped (no fixes needed)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Auto-fix workflow failed with status: ${{ github.event.workflow_run.conclusion }}"
            echo "status=failure" >> $GITHUB_OUTPUT
            exit 1
          fi

  # Main CI/CD pipeline
  build:
    # Run after auto-fix check (for workflow_run) or directly (for push/PR)
    needs: [wait-for-auto-fix]
    if: always() && (needs.wait-for-auto-fix.result == 'success' || github.event_name != 'workflow_run')
    runs-on: ubuntu-latest

    steps:
      - name: Workflow execution context
        run: |
          echo "ğŸš€ Starting CI/CD Pipeline"
          echo "Trigger: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "Auto-fix status: ${{ needs.wait-for-auto-fix.outputs.auto-fix-status }}"
            echo "âœ… Auto-fix workflow completed - proceeding with CI/CD"
          else
            echo "ğŸ”— Direct trigger - auto-fix may run concurrently"
          fi
          echo ""

      - uses: actions/checkout@v4
        with:
          # For workflow_run, checkout the latest commit on the branch (includes auto-fixes)
          # For direct triggers, checkout the triggering commit
          ref: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_branch || github.ref }}
          fetch-depth: 0
          
      - name: Use Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
    
      - name: Install dependencies
        run: |
          echo "ğŸ“¦ Installing npm dependencies..."
          npm install --verbose
          echo "âœ… Dependencies installed successfully"
    
      - name: Display dependency tree
        run: |
          echo "ğŸŒ³ Dependency tree overview:"
          npm list --depth=0 || true
          echo ""
    
      - name: Security Audit
        run: |
          echo "ğŸ”’ Running comprehensive npm security audit..."
          echo "ğŸ” Audit level: moderate (catches moderate and high severity)"
          npm audit --audit-level=moderate
          echo "âœ… Security audit completed - no vulnerabilities found"
    
      - name: Show npm audit summary
        if: failure()
        run: |
          echo "âš ï¸ Security audit failed - showing detailed report:"
          npm audit || true
          echo ""
          echo "ğŸ”§ Available fixes:"
          npm audit fix --dry-run || true
    
      - name: Run tests
        run: |
          echo "ğŸ§ª Running test suite..."
          npm test
          echo "âœ… All tests passed"
    
      - name: Run lint
        run: |
          echo "ğŸ” Running ESLint code quality checks..."
          npm run lint
          echo "âœ… Code quality checks passed"
    
      - name: Build summary
        if: success()
        run: |
          echo "ğŸ‰ Build completed successfully!"
          echo "âœ… Dependencies: Installed"
          echo "âœ… Security: No vulnerabilities"
          echo "âœ… Tests: All passing"
          echo "âœ… Linting: No issues"
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "âœ… Auto-fix: Completed before CI/CD"
          fi